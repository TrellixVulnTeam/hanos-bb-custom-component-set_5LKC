{"version":3,"file":"webhead.module.js","sources":["../src/webhead.js"],"sourcesContent":["import cheerio from 'cheerio';\nimport FormData from 'form-data';\nimport fs from 'fs-extra';\nimport nodeFetch from 'node-fetch';\nimport param from 'jquery-param';\nimport toughCookie from 'tough-cookie';\n\nconst { CookieJar } = toughCookie;\n\nconst Webhead = (opts) => {\n  const { jarFile, userAgent, verbose, beforeSend, complete } = opts || {};\n\n  let webhead = {},\n    session = {},\n    cookieJar,\n    cachedCheerio,\n    cachedJSON,\n    request = async (method, url, options) => {\n      let parameters = {\n        method: method.toUpperCase(),\n        url: toURL(url),\n        options: toOptions(options),\n      };\n\n      if (beforeSend) {\n        parameters = beforeSend(parameters, session);\n        parameters.method = parameters.method.toUpperCase();\n        parameters.url = toURL(parameters.url);\n        parameters.options = toOptions(parameters.options);\n      }\n\n      const { response, redirect } = await fetch(parameters);\n\n      if (redirect) {\n        return request(redirect.method, redirect.url, redirect.options);\n      }\n\n      webhead.url = parameters.url;\n      webhead.cookie = getCookie(webhead.url.href);\n      webhead.response = response;\n\n      if (complete) {\n        complete(parameters, session, webhead);\n      }\n\n      return response;\n    },\n    toURL = (url) => {\n      if (url.constructor == URL) {\n        url = url.href;\n      }\n      return new URL(url, webhead.url);\n    },\n    toOptions = (object) => {\n      object || (object = {});\n      object.headers = toHeaders(object.headers);\n      return object;\n    },\n    toHeaders = (object) => {\n      if (object) {\n        return Object.entries(object).reduce((object, [key, value]) => {\n          if (key.toLowerCase() != 'set-cookie' && Array.isArray(value)) {\n            value = value.join('; ');\n          }\n          object[key.replace(/\\b./g, (c) => c.toUpperCase())] = value;\n          return object;\n        }, {});\n      } else {\n        return {};\n      }\n    },\n    fetch = async ({ method, url, options }) => {\n      let { headers, data, multiPartData, json } = options;\n\n      const cookie = getCookie(url.href),\n        opts = {\n          method,\n          headers: Object.assign({}, headers),\n          redirect: 'manual',\n        };\n\n      opts.headers['Host'] = url.host;\n      url = url.href;\n\n      if (cookie.length) {\n        opts.headers['Cookie'] = cookie;\n      }\n\n      if (!opts.headers['User-Agent'] && userAgent) {\n        opts.headers['User-Agent'] = userAgent;\n      }\n\n      if (data) {\n        if (method == 'GET') {\n          url += (url.match(/\\?/) ? '&' : '?') + param(data);\n        } else {\n          if (!opts.headers['Content-Type']) {\n            opts.headers['Content-Type'] = 'application/x-www-form-urlencoded';\n          }\n          opts.body = param(data);\n        }\n      } else if (multiPartData) {\n        const form = new FormData();\n\n        (multiPartData || []).forEach((part) => {\n          if (part.file) {\n            form.append(part.name, fs.createReadStream(part.file));\n          } else {\n            form.append(\n              part.name,\n              part.hasOwnProperty('value') ? part.value : part.contents\n            );\n          }\n        });\n\n        opts.body = form;\n        opts.headers = {\n          ...opts.headers,\n          ...form.getHeaders(),\n        };\n      }\n\n      if (json) {\n        opts.headers['Content-Type'] = 'application/json';\n        opts.body = JSON.stringify(json);\n      }\n\n      verbose && console.log(method, url, opts);\n      let response = await nodeFetch(url, {\n        method,\n        ...opts,\n      });\n\n      return await handleResponse(method, url, options, response);\n    },\n    handleResponse = async (method, url, options, response) => {\n      const statusCode = response.status,\n        data = await response.text(),\n        headers = toHeaders(response.headers.raw());\n\n      verbose && console.log({ statusCode, data, headers });\n\n      if (headers['Set-Cookie']) {\n        const cookieUrl = toCookieUrl(url);\n\n        headers['Set-Cookie'].forEach((cookie) => {\n          cookieJar.setCookieSync(cookie, cookieUrl);\n        });\n\n        if (jarFile) {\n          const cookies = cookieJar.toJSON().cookies;\n          let json = {};\n\n          if (fs.pathExistsSync(jarFile)) {\n            json = fs.readJsonSync(jarFile);\n          }\n\n          if (json.constructor == Object) {\n            json.cookies = cookies;\n          } else {\n            json = cookies;\n          }\n\n          fs.writeFileSync(jarFile, JSON.stringify(json, null, 2));\n        }\n      }\n\n      let redirect;\n\n      if (/^3/.test('' + statusCode)) {\n        redirect = {\n          method,\n          url: headers['Location'],\n          options,\n        };\n        if (statusCode <= 303) {\n          redirect.method = 'GET';\n          delete redirect.options.data;\n        }\n      }\n\n      cachedCheerio = undefined;\n      cachedJSON = undefined;\n\n      return {\n        response: { statusCode, data, headers },\n        redirect,\n      };\n    },\n    toCookieUrl = (url) => {\n      return url.replace(/\\?.*/, '');\n    },\n    getCookie = (url) => {\n      return cookieJar.getCookiesSync(toCookieUrl(url)).join('; ');\n    };\n\n  `get post put patch delete head options`.split(' ').forEach((method) => {\n    webhead[method] = async (...parameters) =>\n      await request(method, ...parameters);\n  });\n\n  webhead.text = () => {\n    return webhead.response ? webhead.response.data : '';\n  };\n\n  webhead.json = () => {\n    if (!cachedJSON && webhead.response) {\n      const { data, headers } = webhead.response;\n      if (data && ('' + headers['Content-Type']).match('json')) {\n        cachedJSON = JSON.parse(data);\n      }\n    }\n    return cachedJSON;\n  };\n\n  webhead.$ = (...args) => {\n    if (!cachedCheerio && webhead.response) {\n      const { data, headers } = webhead.response;\n      const match = ('' + headers['Content-Type']).match(/(html|xml)/);\n      if (match) {\n        cachedCheerio = cheerio.load(data, { xmlMode: match[1] == 'xml' });\n      }\n    }\n    return cachedCheerio ? cachedCheerio(...args) : [];\n  };\n\n  webhead.submit = async (selector, data, options) => {\n    const form = webhead.$(selector);\n    if (form.length) {\n      const url = form.attr('action'),\n        method = form.attr('method') || 'GET';\n\n      data = Object.assign(\n        form.serializeArray().reduce((data, { name, value }) => {\n          data[name] = value;\n          return data;\n        }, {}),\n        data || {}\n      );\n\n      return await request(method, url, { ...options, data });\n    }\n  };\n\n  webhead.clearCookies = () => {\n    cookieJar.removeAllCookiesSync();\n  };\n\n  if (fs.pathExistsSync(jarFile)) {\n    const json = fs.readJsonSync(jarFile),\n      cookies = json.cookies || json;\n\n    cookieJar = CookieJar.fromJSON({\n      cookies: cookies.constructor == Array ? cookies : [],\n    });\n  } else {\n    cookieJar = new CookieJar();\n  }\n\n  return webhead;\n};\n\nexport default Webhead;\n"],"names":["CookieJar","toughCookie","opts","cookieJar","cachedCheerio","cachedJSON","jarFile","userAgent","verbose","beforeSend","complete","webhead","session","request","method","url","options","parameters","toUpperCase","toURL","toOptions","fetch","response","redirect","cookie","getCookie","href","constructor","URL","object","headers","toHeaders","Object","entries","reduce","key","value","toLowerCase","Array","isArray","join","replace","c","data","multiPartData","json","assign","host","length","match","param","body","form","FormData","forEach","part","append","name","file","fs","createReadStream","hasOwnProperty","contents","getHeaders","JSON","stringify","console","log","nodeFetch","handleResponse","statusCode","status","text","raw","cookieUrl","toCookieUrl","setCookieSync","cookies","toJSON","pathExistsSync","readJsonSync","writeFileSync","test","undefined","getCookiesSync","split","parse","$","cheerio","load","xmlMode","submit","selector","attr","serializeArray","clearCookies","removeAllCookiesSync","fromJSON"],"mappings":"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"}